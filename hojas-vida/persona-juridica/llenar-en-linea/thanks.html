<!doctype html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>¬°Pago Completado! ‚Äì Descarga tu Hoja de Vida</title>
  <link rel="stylesheet" href="/styles-shared.css" />
  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 0;
      padding: 0;
    }

    /* Header adjustments for this page */
    header {
      width: 100%;
      margin-bottom: 40px;
    }

    .container.main-card {
      background: white;
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      max-width: 600px;
      width: 90%;
      text-align: center;
      margin-bottom: 40px;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .success-icon {
      font-size: 60px;
      margin-bottom: 20px;
      animation: pulse 0.6s ease-out;
    }

    @keyframes pulse {
      0% {
        transform: scale(0.8);
        opacity: 0;
      }

      50% {
        transform: scale(1.1);
      }

      100% {
        transform: scale(1);
        opacity: 1;
      }
    }

    h1 {
      color: #06233a;
      font-size: 28px;
      margin: 0 0 10px 0;
    }

    p {
      color: #666;
      font-size: 16px;
      line-height: 1.6;
      margin: 0 0 30px 0;
    }

    .download-section {
      margin: 30px 0;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .download-section p {
      color: #555;
      font-size: 14px;
      margin-bottom: 15px;
    }

    .btn {
      display: inline-block;
      padding: 12px 30px;
      background: #667eea;
      color: white;
      text-decoration: none;
      border-radius: 6px;
      cursor: pointer;
      border: none;
      font-size: 16px;
      font-weight: 600;
      transition: background 0.3s, transform 0.2s;
    }

    .btn:hover {
      background: #5568d3;
      transform: translateY(-2px);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn-secondary {
      background: #6c757d;
      margin-top: 15px;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }

    .info-box {
      background: #e7f3ff;
      border-left: 4px solid #667eea;
      padding: 15px;
      text-align: left;
      margin: 20px 0;
      border-radius: 4px;
      font-size: 14px;
      color: #333;
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .error-message {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
      padding: 15px;
      border-radius: 4px;
      margin: 20px 0;
      display: none;
    }

    .success-message {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
      padding: 15px;
      border-radius: 4px;
      margin: 20px 0;
      display: none;
    }

    .status-badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: bold;
      margin-bottom: 20px;
      text-transform: uppercase;
    }

    .status-approved {
      background: #d4edda;
      color: #155724;
    }

    .status-pending {
      background: #fff3cd;
      color: #856404;
    }

    .status-declined {
      background: #f8d7da;
      color: #721c24;
    }

    .status-voided {
      background: #e2e3e5;
      color: #383d41;
    }
  </style>
</head>

<body>
  <header>
    <div class="container topbar">
      <div class="brand">
        <div class="logo">F</div>
        <div>
          formatounico.com
          <div style="font-size: 12px; color: var(--muted); font-weight: 600">
            Formatos legales listos para llenar en l√≠nea
          </div>
        </div>
      </div>
      <nav id="main-nav" aria-hidden="true">
        <button class="nav-close" aria-label="Cerrar men√∫" id="nav-close">
          √ó
        </button>
        <ul>
          <li><a href="/">Inicio</a></li>
          <li><a href="/#formatos">Formatos</a></li>
          <li><a href="/#como-funciona">C√≥mo funciona</a></li>
          <li><a href="/">FAQ</a></li>
        </ul>
      </nav>
      <div id="nav-backdrop" class="nav-backdrop" aria-hidden="true"></div>
      <div class="search">
        <button class="btn btn-ghost mobile-only" id="menu-toggle" aria-controls="main-nav" aria-expanded="false">
          ‚ò∞
        </button>
      </div>
    </div>
  </header>

  <div class="container main-card">
    <div class="success-icon" id="success-icon">‚úÖ</div>
    <h1 id="page-title">Verificando Pago...</h1>
    <p id="page-description">Estamos validando tu pago con Wompi para habilitar la descarga.</p>

    <div id="payment-status-container" style="display: none;">
      <div id="status-badge" class="status-badge"></div>
    </div>

    <div class="info-box" id="info-box">
      <strong>üìù Nota:</strong> Tu documento est√° listo para descargar en formato PDF con todos los datos que
      diligenciaste.
    </div>

    <div class="download-section" id="download-section" style="display: none;">
      <p>Descarga tu documento aqu√≠:</p>
      <button id="btn-download-pdf" class="btn" disabled>
        üìÑ Descargar Hoja de Vida (PDF)
      </button>
      <div id="download-spinner" class="spinner" style="display: none; margin-top: 10px;"></div>
    </div>

    <div id="loading-section">
      <div class="spinner" id="spinner"></div>
      <p id="loading-text" style="font-size: 14px; color: #666;">Consultando estado de la transacci√≥n...</p>
    </div>

    <div class="error-message" id="error-message"></div>
    <div class="success-message" id="success-message">‚úÖ Documento descargado correctamente</div>

    <p style="margin-top: 30px; font-size: 14px; color: #999;">
      <a href="/" style="color: #667eea; text-decoration: none;">‚Üê Volver al inicio</a>
    </p>
  </div>

  <!-- Cargar librer√≠as necesarias para generar PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>

  <script>
    const { PDFDocument, StandardFonts, rgb } = PDFLib;

    // Funci√≥n para obtener par√°metros de la URL
    function getUrlParams() {
      const params = new URLSearchParams(window.location.search);
      return Object.fromEntries(params);
    }

    // Funci√≥n para validar c√≥digo de transacci√≥n
    function validateTransactionCode() {
      const params = getUrlParams();

      // Buscar par√°metros comunes de Wompi (reference, transaction_id, id, etc)
      const validCodes = [
        'reference',
        'transaction_id',
        'id',
        'transactionId',
        'reference_code',
        'codigo'
      ];

      for (let code of validCodes) {
        if (params[code]) {
          console.log(`‚úÖ C√≥digo de transacci√≥n validado: ${code}=${params[code]}`);
          return { valid: true, code: code, value: params[code] };
        }
      }

      console.log('‚ùå No se encontr√≥ c√≥digo de transacci√≥n en la URL');
      return { valid: false };
    }

    // Funci√≥n para mostrar pantalla de error
    function showErrorScreen(title, message) {
      document.getElementById('success-icon').textContent = '‚ùå';
      document.getElementById('success-icon').style.color = '#dc3545';
      document.getElementById('page-title').textContent = title || '‚ö†Ô∏è Error de Validaci√≥n';
      document.getElementById('page-description').textContent = message ||
        'No se pudo validar tu pago. Por favor, intenta de nuevo o contacta al soporte.';
      document.getElementById('info-box').style.display = 'none';
      document.getElementById('download-section').style.display = 'none';
      document.getElementById('loading-section').style.display = 'none';
      document.getElementById('payment-status-container').style.display = 'none';

      const errorDiv = document.getElementById('error-message');
      errorDiv.textContent = '‚ùå ' + (message || 'Acceso denegado. Es posible que el pago no se haya completado o que el ID de transacci√≥n sea inv√°lido.');
      errorDiv.style.display = 'block';
    }

    // Funci√≥n para consultar el estado en Wompi
    async function checkWompiStatus(transactionId) {
      const loadingText = document.getElementById('loading-text');
      const spinner = document.getElementById('spinner');
      const downloadSection = document.getElementById('download-section');
      const statusContainer = document.getElementById('payment-status-container');
      const statusBadge = document.getElementById('status-badge');
      const pageTitle = document.getElementById('page-title');
      const pageDescription = document.getElementById('page-description');

      try {
        // Intentar consultar la API de Wompi (Endpoint p√∫blico de transacciones)
        // Nota: Wompi permite consultar transacciones por ID de forma p√∫blica en producci√≥n
        const response = await fetch(`https://production.wompi.co/v1/transactions/${transactionId}`);

        if (!response.ok) {
          throw new Error('No se pudo obtener informaci√≥n de la transacci√≥n desde Wompi.');
        }

        const { data } = await response.json();
        const status = data.status; // APPROVED, DECLINED, VOIDED, PENDING

        console.log('--- ESTADO DE WOMPI ---', status);

        // Actualizar UI seg√∫n el estado
        document.getElementById('loading-section').style.display = 'none';
        statusContainer.style.display = 'block';
        statusBadge.textContent = `Estado: ${status}`;
        statusBadge.className = `status-badge status-${status.toLowerCase()}`;

        if (status === 'APPROVED') {
          pageTitle.textContent = '¬°Pago Exitoso! ‚úÖ';
          pageDescription.textContent = 'Tu pago se ha confirmado. Ya puedes descargar tu documento.';
          downloadSection.style.display = 'block';
          document.getElementById('btn-download-pdf').disabled = false;
          document.getElementById('success-icon').textContent = '‚úÖ';
        } else if (status === 'PENDING') {
          pageTitle.textContent = 'Pago Pendiente ‚è≥';
          pageDescription.textContent = 'Tu pago a√∫n se est√° procesando. Por favor espera unos segundos o recarga la p√°gina.';
          showRetryButton(transactionId);
        } else {
          pageTitle.textContent = 'Pago no Exitoso ‚ùå';
          pageDescription.textContent = `Lo sentimos, el pago fue ${status}. No se puede habilitar la descarga.`;
          showErrorScreen('Pago no realizado', `La transacci√≥n fue ${status}. Por favor intenta pagar nuevamente.`);
        }

      } catch (error) {
        console.error('Error verificando pago:', error);
        showErrorScreen('Error de Conexi√≥n', 'Hubo un problema al conectar con Wompi. Por favor recarga la p√°gina.');
      }
    }

    function showRetryButton(id) {
      const loadingSection = document.getElementById('loading-section');
      loadingSection.innerHTML = `
          <p style="color: #856404;">El pago sigue en proceso...</p>
          <button onclick="window.location.reload()" class="btn btn-secondary">
            üîÑ Reintentar Verificaci√≥n
          </button>
        `;
      loadingSection.style.display = 'block';
    }

    // Funci√≥n para generar PDF (adaptada de app.js)
    async function generateFinalPDF(formData) {
      try {
        // Obtener la plantilla PDF desde la carpeta actual
        const pdfResponse = await fetch('plantilla.pdf');
        if (!pdfResponse.ok) {
          throw new Error('No se pudo cargar la plantilla PDF');
        }
        const pdfBytes = await pdfResponse.arrayBuffer();
        const pdfDoc = await PDFDocument.load(pdfBytes);
        const page = pdfDoc.getPages()[0];
        const font = await pdfDoc.embedFont(StandardFonts.HelveticaBold);

        const draw = (text, x, y, size = 10) => {
          if (!text) return;
          page.drawText(String(text), {
            x,
            y,
            size,
            font,
            color: rgb(0, 0, 0),
          });
        };


        // Mapeo de coordenadas: nombre del campo -> posici√≥n en PDF
        const pdfCoordinates = {
          razonSocial: { x: 135, y: 640 },
          sigla: { x: 55, y: 626 },
          nit: { x: 440, y: 626 },
          orden_nal: { x: 46, y: 586 },
          orden_dptl: { x: 76, y: 586 },
          orden_dstr: { x: 106, y: 586 },
          orden_mpl: { x: 136, y: 586 },
          orden_otro: { x: 166, y: 586 },
          ordenCual: { x: 223, y: 586 },
          tipo: { x: 304, y: 586 },
          clase: { x: 464, y: 586 },
          pais: { x: 170, y: 561 },
          departamento: { x: 353, y: 561 },
          municipio: { x: 70, y: 548 },
          direccion: { x: 283, y: 548 },
          telefonos: { x: 72, y: 535 },
          fax: { x: 255, y: 535 },
          apartadoAereo: { x: 500, y: 535 },
          servicio1: { x: 50, y: 485 },
          servicio2: { x: 320, y: 485 },
          servicio3: { x: 50, y: 470 },
          servicio4: { x: 320, y: 470 },
          servicio5: { x: 50, y: 458 },
          servicio6: { x: 320, y: 458 },
          experiencia1: { x: 35, y: 393 },
          tipoEmpresa1_publica: { x: 293, y: 393 },
          tipoEmpresa1_privada: { x: 323, y: 393 },
          telefono_exp1: { x: 343, y: 393 },
          fecha_term_exp1: { x: 420, y: 393 },
          valorContrato_exp1: { x: 502, y: 393 },
          experiencia2: { x: 35, y: 380 },
          tipoEmpresa2_publica: { x: 293, y: 378 },
          tipoEmpresa2_privada: { x: 323, y: 378 },
          telefono_exp2: { x: 343, y: 380 },
          fecha_term_exp2: { x: 420, y: 380 },
          valorContrato_exp2: { x: 502, y: 380 },
          experiencia3: { x: 35, y: 367 },
          tipoEmpresa3_publica: { x: 293, y: 365 },
          tipoEmpresa3_privada: { x: 323, y: 365 },
          telefono_exp3: { x: 343, y: 367 },
          fecha_term_exp3: { x: 420, y: 367 },
          valorContrato_exp3: { x: 502, y: 367 },
          experiencia4: { x: 35, y: 354 },
          tipoEmpresa4_publica: { x: 293, y: 352 },
          tipoEmpresa4_privada: { x: 323, y: 352 },
          telefono_exp4: { x: 343, y: 354 },
          fecha_term_exp4: { x: 420, y: 354 },
          valorContrato_exp4: { x: 502, y: 354 },
          experiencia5: { x: 35, y: 341 },
          tipoEmpresa5_publica: { x: 293, y: 339 },
          tipoEmpresa5_privada: { x: 323, y: 339 },
          telefono_exp5: { x: 343, y: 341 },
          fecha_term_exp5: { x: 420, y: 341 },
          valorContrato_exp5: { x: 502, y: 341 },
          primerApellido: { x: 87, y: 303 },
          segundoApellido: { x: 306, y: 303 },
          nombres: { x: 410, y: 303 },
          tipo_documento_rep_cc: { x: 63, y: 275 },
          tipo_documento_rep_ce: { x: 103, y: 275 },
          tipo_documento_rep_pasaporte: { x: 173, y: 275 },
          documento: { x: 203, y: 275 },
          caracterde_representante: { x: 383, y: 275 },
          caracterde_apoderado: { x: 444, y: 275 },
          capacidad_contratacion: { x: 468, y: 275 },
          inhabilidad_si: { x: 382, y: 236 },
          inhabilidad_no: { x: 412, y: 236 },
          observaciones: { x: 100, y: 210 },
          fecha_diligenciamiento: { x: 460, y: 172 }
        };

        // Dibujar cada campo en el PDF
        Object.entries(pdfCoordinates).forEach(([field, coords]) => {
          if (formData[field]) {
            draw(formData[field], coords.x, coords.y);
          }
        });

        // Convertir a bytes
        const finalPdfBytes = await pdfDoc.save();
        return finalPdfBytes;
      } catch (error) {
        console.error('Error generando PDF:', error);
        throw error;
      }
    }

    // Cuando se carga la p√°gina
    (function () {
      document.addEventListener('DOMContentLoaded', async () => {
        // VALIDAR C√ìDIGO DE TRANSACCI√ìN DESDE URL
        const validation = validateTransactionCode();
        if (!validation.valid) {
          console.error('‚ùå Validaci√≥n fallida: No hay c√≥digo de transacci√≥n');
          showErrorScreen('Acceso Denegado', 'No se encontr√≥ un ID de transacci√≥n v√°lido. Si acabas de pagar, aseg√∫rate de no haber cerrado la p√°gina antes de tiempo.');
          return;
        }

        const transactionId = validation.value;
        console.log('‚úÖ ID de transacci√≥n encontrado:', transactionId);

        // INICIAR VERIFICACI√ìN REAL CON WOMPI
        await checkWompiStatus(transactionId);

        const downloadBtn = document.getElementById('btn-download-pdf');
        const downloadSpinner = document.getElementById('download-spinner');
        const errorMessage = document.getElementById('error-message');

        downloadBtn.addEventListener('click', async () => {
          try {
            // Obtener datos del localStorage
            const formDataJson = localStorage.getItem('hojaVidaFormData');
            if (!formDataJson) {
              throw new Error(
                'No se encontraron los datos del formulario. Por favor, intenta de nuevo.'
              );
            }

            const formData = JSON.parse(formDataJson);

            // Mostrar spinner de descarga
            downloadSpinner.style.display = 'block';
            downloadBtn.disabled = true;

            // Generar PDF
            const finalPdfBytes = await generateFinalPDF(formData);
            const blob = new Blob([finalPdfBytes], { type: 'application/pdf' });

            // Descargar
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'Hoja_de_Vida_Persona_Juridica.pdf';
            link.click();

            // Ocultar spinner y mostrar mensaje de √©xito
            downloadSpinner.style.display = 'none';
            downloadBtn.disabled = false;
            document.getElementById('success-message').style.display = 'block';

            // Limpiar localStorage despu√©s de descargar
            setTimeout(() => {
              localStorage.removeItem('hojaVidaFormData');
            }, 2000);
          } catch (error) {
            spinner.style.display = 'none';
            downloadBtn.disabled = false;
            errorMessage.textContent = '‚ùå ' + error.message;
            errorMessage.style.display = 'block';
            console.error(error);
          }
        });
      });
    })();

    // Funcionalidad del Men√∫ M√≥vil
    (function () {
      const menuToggle = document.getElementById("menu-toggle");
      const navClose = document.getElementById("nav-close");
      const nav = document.getElementById("main-nav");
      const backdrop = document.getElementById("nav-backdrop");

      function openNav() {
        nav.classList.add("open");
        backdrop.classList.add("open");
        menuToggle.setAttribute("aria-expanded", "true");
        nav.setAttribute("aria-hidden", "false");
        document.body.style.overflow = "hidden";
      }
      function closeNav() {
        nav.classList.remove("open");
        backdrop.classList.remove("open");
        menuToggle.setAttribute("aria-expanded", "false");
        nav.setAttribute("aria-hidden", "true");
        document.body.style.overflow = "";
      }

      if (menuToggle) {
        menuToggle.addEventListener("click", () => {
          const opened = nav.classList.contains("open");
          if (opened) closeNav();
          else openNav();
        });
      }
      if (backdrop) {
        backdrop.addEventListener("click", closeNav);
      }
      if (navClose) {
        navClose.addEventListener("click", closeNav);
      }
      // Cerrar men√∫ al hacer click en un enlace
      const navLinks = nav.querySelectorAll("a");
      navLinks.forEach((link) => {
        link.addEventListener("click", closeNav);
      });
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && nav.classList.contains("open")) closeNav();
      });
    })();
  </script>
</body>

</html>